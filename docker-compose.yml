version: '3'
# for development purposes only

services:
  production:
    build:
      context: .
      dockerfile: Dockerfile
    image: keboola/job-runner

  tests: &tests
    build:
      context: .
      dockerfile: Dockerfile-tests
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - /tmp/:/tmp/
    environment:
      - CPU_COUNT
      - LEGACY_OAUTH_API_URL
      - LEGACY_ENCRYPTION_KEY
      - JOB_QUEUE_URL
      - JOB_QUEUE_TOKEN
      - STORAGE_API_URL
      - AWS_REGION
      - AWS_KMS_KEY_ID
      - AWS_LOGS_S3_BUCKET
      - AZURE_KEY_VAULT_URL
      - AZURE_LOG_ABS_CONNECTION_STRING
      - AZURE_LOG_ABS_CONTAINER
      - TEST_STORAGE_API_TOKEN
      - TEST_AWS_ACCESS_KEY_ID
      - TEST_AWS_SECRET_ACCESS_KEY
      - TEST_AZURE_CLIENT_ID
      - TEST_AZURE_CLIENT_SECRET
      - TEST_AZURE_TENANT_ID

    command:
      composer ci
    depends_on:
      - internal-api

  tests-local:
    <<: *tests
    volumes:
      - ./:/code
      - /tmp/:/tmp/
      - /var/run/docker.sock:/var/run/docker.sock
    command:
      - /bin/bash


  internal-api:
    image: keboolapes.azurecr.io/job-queue-internal-api:7262
    ports:
      - "81:80"
    volumes:
      # to get wait-for-it
      - ./:/build-code
    environment:
      - log_abs_connection_string=
      - log_abs_container=debug-files
      - logs_s3_bucket=
      - logs_s3_bucket_region=
      - MYSQL_ROOT_PASSWORD=root
      - DATABASE_USER=root
      - DATABASE_PASSWORD=root
      - DATABASE_HOST=mysql
      - DATABASE_PORT=3306
      - DATABASE_NAME=jobs

    command: ['sh', '-c', '/build-code/docker/wait-for-it.sh --strict --timeout=120 mysql:3306 -- php bin/console doctrine:migrations:migrate && apache2-foreground']
    depends_on:
      - mysql

  mysql:
    image: mysql:8
    command: --default-authentication-plugin=mysql_native_password
    ports:
      - "3307:3306"
    environment:
      - MYSQL_DATABASE=jobs
      - MYSQL_ROOT_PASSWORD=root
