{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "Job Runner Services Stack",
  "Parameters": {
    "KeboolaStack": {
      "Type": "String",
      "Description": "All resources will be tagged by this value."
    },
    "EcrRepositoryName": {
      "Type": "String",
      "Description": "ECR repository name",
      "Default": "keboola/job-runner"
    }
  },
  "Resources": {
    "DeployPolicy": {
      "Type": "AWS::IAM::ManagedPolicy",
      "Properties": {
        "Description": {
          "Fn::Join": [
            " - ",
            [{
                "Ref": "KeboolaStack"
              },
              "Job Runner Deployment"
            ]
          ]
        },
        "PolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Sid": "AllowEcrPush",
              "Effect": "Allow",
              "Action": [
                "ecr:PutImage",
                "ecr:CompleteLayerUpload",
                "ecr:InitiateLayerUpload",
                "ecr:UploadLayerPart",
                "ecr:BatchCheckLayerAvailability"
              ],
              "Resource": [{
                "Fn::GetAtt": [
                  "EcrRepository",
                  "Arn"
                ]
              }]
            },
            {
              "Sid": "AllowEcrAuth",
              "Effect": "Allow",
              "Action": [
                "ecr:GetAuthorizationToken"
              ],
              "Resource": "*"
            }
          ]
        }
      }
    },
    "EcrRepository": {
      "Type": "AWS::ECR::Repository",
      "Properties": {
        "RepositoryName": {
          "Ref": "EcrRepositoryName"
        },
        "Tags": [
          {
            "Key": "KeboolaRole",
            "Value": "job-queue"
          },
          {
            "Key": "KeboolaStack",
            "Value": {
              "Ref": "KeboolaStack"
            }
          }
        ]
      }
    }
  },
  "Outputs": {
    "DeployPolicy": {
      "Value": {
        "Ref": "DeployPolicy"
      }
    }
  }
}
